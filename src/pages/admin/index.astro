---
import Layout from '../../layouts/Layout.astro';
import AdminNav from '../../components/AdminNav.astro';
import { getLatestConference, getBoardMembers, getHallOfFameNominations } from '../../lib/db';

// Get user from cookies and add debug logging
const userCookie = Astro.cookies.get('user');
console.log('User cookie:', userCookie?.value);

let user = null;
try {
  user = userCookie ? JSON.parse(userCookie.value) : null;
  console.log('Parsed user data:', user);
} catch (error) {
  console.error('Error parsing user cookie:', error);
}

// Debug check for user role
console.log('User role:', user?.role);

// Redirect if not authenticated or not admin
if (!user || user.role !== 'admin') {
  console.log('Access denied - redirecting to login');
  console.log('Auth status:', !!user);
  console.log('User role check:', user?.role === 'admin');
  return Astro.redirect('/login');
}

// Fetch data for dashboard
let conference = null;
let boardMembers = [];
let nominations = [];
let error = null;

try {
  [conference, boardMembers, nominations] = await Promise.all([
    getLatestConference(),
    getBoardMembers(),
    getHallOfFameNominations()
  ]);
} catch (e) {
  error = e instanceof Error ? e.message : 'Failed to load dashboard data';
}
---

<Layout title="Admin Dashboard">
  <AdminNav currentPath="/admin" />
  
  <div class="container mx-auto px-4 py-8">
    <div class="mb-8">
      <h1 class="text-2xl font-bold text-gray-900">Admin Dashboard</h1>
      <p class="text-gray-600 mt-2">Welcome back, {user.email}</p>
    </div>

    {error && (
      <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-8">
        <p class="text-red-700">{error}</p>
      </div>
    )}
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Conference Management Card -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-primary-700">Conference</h2>
          <a href="/admin/conferences" class="text-primary-600 hover:text-primary-800">
            Manage
          </a>
        </div>
        {conference ? (
          <div>
            <p class="text-gray-600 mb-2">{conference.name}</p>
            <p class="text-sm text-gray-500">
              {new Date(conference.start_date).toLocaleDateString()} - {new Date(conference.end_date).toLocaleDateString()}
            </p>
            <p class="text-sm text-gray-500 mt-1">{conference.location}</p>
          </div>
        ) : (
          <p class="text-gray-600">No upcoming conference scheduled</p>
        )}
      </div>

      <!-- Board Members Card -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-primary-700">Board Members</h2>
          <a href="/admin/board" class="text-primary-600 hover:text-primary-800">
            Manage
          </a>
        </div>
        <div>
          <p class="text-3xl font-bold text-gray-700 mb-2">{boardMembers.length}</p>
          <p class="text-gray-600">Active board members</p>
        </div>
      </div>

      <!-- Hall of Fame Card -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-primary-700">Hall of Fame</h2>
          <a href="/admin/hall-of-fame" class="text-primary-600 hover:text-primary-800">
            View All
          </a>
        </div>
        <div>
          <p class="text-3xl font-bold text-gray-700 mb-2">{nominations.length}</p>
          <p class="text-gray-600">New nominations</p>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-3">
        <h2 class="text-xl font-semibold text-primary-700 mb-4">Quick Actions</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <a 
            href="/admin/conferences/new"
            class="flex items-center justify-center p-4 bg-primary-50 rounded-lg hover:bg-primary-100 transition-colors"
          >
            <span class="text-primary-700">Create New Conference</span>
          </a>
          <a 
            href="/admin/board/new"
            class="flex items-center justify-center p-4 bg-primary-50 rounded-lg hover:bg-primary-100 transition-colors"
          >
            <span class="text-primary-700">Add Board Member</span>
          </a>
          <a 
            href="/admin/users"
            class="flex items-center justify-center p-4 bg-primary-50 rounded-lg hover:bg-primary-100 transition-colors"
          >
            <span class="text-primary-700">Manage Users</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Debug Info (only visible in development) -->
    {import.meta.env.DEV && (
      <div class="mt-8 p-4 bg-gray-100 rounded-lg">
        <h2 class="text-lg font-semibold mb-2">Debug Information</h2>
        <pre class="whitespace-pre-wrap text-sm">
          {JSON.stringify({ user }, null, 2)}
        </pre>
      </div>
    )}
  </div>
</Layout>